<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MON-20 Marketplace — $MONS (Monad Testnet)</title>
  <meta name="description" content="First inscription token marketplace for MON-20 on Monad Testnet — $MONS" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81'
            }
          }
        }
      }
    }
  </script>
  <style>
    html { color-scheme: dark; }
    .glass { backdrop-filter: saturate(120%) blur(10px); background: rgba(17, 24, 39, .6); }
    .card { @apply rounded-2xl shadow-lg border border-white/10 bg-slate-900/60; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-medium border border-white/10 hover:border-white/20 transition; }
    .btn-primary { @apply bg-brand-600 hover:bg-brand-500 text-white; }
    .input { @apply w-full rounded-xl bg-slate-800/60 border border-white/10 px-3 py-2 outline-none focus:ring-2 focus:ring-brand-500; }
    .label { @apply text-sm text-slate-300 mb-1; }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 via-slate-950 to-black text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 glass border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-brand-600 grid place-items-center font-bold">M</div>
        <div>
          <h1 class="text-lg font-semibold">MON-20 Marketplace<span class="hidden sm:inline"> — $MONS</span></h1>
          <p class="text-xs text-slate-400">Monad Testnet · Chain ID 10143</p>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <div id="networkBadge" class="hidden sm:flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-slate-800 border border-white/10">Network: <span class="font-medium" id="netName">—</span></div>
        <div id="balanceBox" class="hidden sm:flex items-center gap-2 text-xs px-3 py-1 rounded-full bg-slate-800 border border-white/10 mono">MON: <span id="monBalance">0.00</span></div>
        <button id="connectBtn" class="btn btn-primary">Connect Wallet</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="max-w-7xl mx-auto px-4 py-10">
    <div class="grid lg:grid-cols-2 gap-6 items-stretch">
      <div class="card p-6">
        <h2 class="text-2xl font-bold">Trade MON-20 Inscriptions</h2>
        <p class="text-slate-300 mt-2">First inscription token on Monad Testnet. Ticker <span class="font-semibold">$MONS</span>, total supply <span class="mono" id="supplyText">21,000,000</span>, limit <span class="mono">1,000</span> MONS / mint. Prices are in <strong>MON</strong>.</p>
        <div class="mt-4 flex flex-wrap gap-2 text-xs text-slate-400">
          <span class="px-2 py-1 rounded-full bg-slate-800 border border-white/10">Marketplace: <span class="mono">0xB28A…9fDa6</span></span>
          <span class="px-2 py-1 rounded-full bg-slate-800 border border-white/10">MON-20: <span class="mono">0x0716…e5fA6</span></span>
          <span class="px-2 py-1 rounded-full bg-slate-800 border border-white/10">Decimals: 18</span>
        </div>
        <div class="mt-6 grid sm:grid-cols-3 gap-3">
          <div class="card p-4">
            <div class="text-xs text-slate-400">Minted</div>
            <div class="text-2xl font-semibold mono" id="mintedStat">—</div>
            <div class="text-xs text-slate-400" id="mintProgress">—</div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-slate-400">Holders</div>
            <div class="text-2xl font-semibold mono" id="holdersStat">—</div>
            <div class="text-xs text-slate-400">unique addresses</div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-slate-400">Floor Price</div>
            <div class="text-2xl font-semibold mono" id="floorPrice">—</div>
            <div class="text-xs text-slate-400">per MONS</div>
          </div>
        </div>
        <div class="mt-3 grid sm:grid-cols-3 gap-3">
          <div class="card p-4">
            <div class="text-xs text-slate-400">24h Volume</div>
            <div class="text-2xl font-semibold mono" id="vol24h">—</div>
            <div class="text-xs text-slate-400">MON</div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-slate-400">Total Volume</div>
            <div class="text-2xl font-semibold mono" id="volTotal">—</div>
            <div class="text-xs text-slate-400">MON</div>
          </div>
          <div class="card p-4">
            <div class="text-xs text-slate-400">Active Listings</div>
            <div class="text-2xl font-semibold mono" id="activeListings">—</div>
            <div class="text-xs text-slate-400">for MONS</div>
          </div>
        </div>
      </div>

      <!-- Quick Mint Card -->
      <div class="card p-6">
        <h3 class="text-xl font-semibold">Quick Mint — $MONS</h3>
        <p class="text-sm text-slate-300">Mint direct from the MON-20 contract on Monad Testnet.</p>
        <div class="mt-4 grid sm:grid-cols-2 gap-4">
          <div>
            <label class="label">Amount (MONS)</label>
            <input id="mintAmount" class="input mono" type="number" min="1" step="1" placeholder="e.g. 1000" value="1000" />
            <p class="text-xs text-slate-400 mt-1">Limit per mint: <span class="mono" id="limitPerMint">—</span></p>
          </div>
          <div>
            <label class="label">Mint Fee (MON)</label>
            <input id="mintFeeDisplay" class="input mono" type="text" disabled value="—" />
            <p class="text-xs text-slate-400 mt-1">Fee is paid in MON native.</p>
          </div>
        </div>
        <div class="mt-4 flex gap-3">
          <button id="mintBtn" class="btn btn-primary">Mint</button>
          <button id="refreshBtn" class="btn">Refresh Stats</button>
        </div>
        <p id="mintMsg" class="text-xs text-slate-400 mt-3"></p>
      </div>
    </div>
  </section>

  <!-- Marketplace -->
  <section class="max-w-7xl mx-auto px-4 pb-20">
    <div class="flex items-end justify-between gap-3 mb-3">
      <div>
        <h3 class="text-xl font-semibold">Live Listings — $MONS</h3>
        <p class="text-slate-400 text-sm">Buy and sell MONS inscriptions. Prices in MON.</p>
      </div>
      <div class="flex gap-2">
        <button id="sellOpenBtn" class="btn btn-primary">Create Listing</button>
        <button id="myListingsBtn" class="btn">My Listings</button>
      </div>
    </div>

    <div class="card overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-800/60">
            <tr class="text-left text-slate-300">
              <th class="px-4 py-3">Listing ID</th>
              <th class="px-4 py-3">Seller</th>
              <th class="px-4 py-3">Amount (MONS)</th>
              <th class="px-4 py-3">Price / MONS (MON)</th>
              <th class="px-4 py-3">Created</th>
              <th class="px-4 py-3">Action</th>
            </tr>
          </thead>
          <tbody id="listingsBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Sell Modal -->
  <div id="sellModal" class="fixed inset-0 hidden place-items-center bg-black/60 p-4">
    <div class="card w-full max-w-lg p-6">
      <div class="flex items-center justify-between">
        <h4 class="text-lg font-semibold">Create Listing</h4>
        <button class="btn" onclick="toggleSell(false)">✕</button>
      </div>
      <div class="grid sm:grid-cols-2 gap-4 mt-4">
        <div>
          <label class="label">Ticker</label>
          <input class="input" value="MONS" disabled />
          <p class="text-xs text-slate-400 mt-1">Only MONS supported.</p>
        </div>
        <div>
          <label class="label">Your MONS Balance</label>
          <input id="userMonsBal" class="input mono" value="—" disabled />
        </div>
        <div>
          <label class="label">Amount to List (MONS)</label>
          <input id="sellAmount" class="input mono" type="number" min="1" step="1" placeholder="e.g. 1000" />
        </div>
        <div>
          <label class="label">Price per MONS (MON)</label>
          <input id="sellPrice" class="input mono" type="number" min="0" step="0.000000000000000001" placeholder="e.g. 0.01" />
        </div>
      </div>
      <div class="mt-5 flex gap-3">
        <button id="createListingBtn" class="btn btn-primary">List for Sale</button>
        <button class="btn" onclick="toggleSell(false)">Cancel</button>
      </div>
      <p id="sellMsg" class="text-xs text-slate-400 mt-3"></p>
    </div>
  </div>

  <footer class="border-t border-white/10 py-8 text-center text-sm text-slate-400">
    Created by <a class="underline hover:text-slate-200" href="https://x.com/ega_2ez4crypto" target="_blank" rel="noopener">@ega_2ez4crypto</a> · Contract: <span class="mono">0x07169f0F890C3595421512D98DC79b8bce6E5fA6</span>
  </footer>

  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <script>
  ;(function(){
    const MARKETPLACE_ADDR = "0xB28AC2AfADCcc79cd74c487BEE0a841bBE89fDa6"; // marketplace
    const MON20_ADDR       = "0x07169f0F890C3595421512D98DC79b8bce6E5fA6"; // MON-20 inscription
    const RPC_URL          = "https://testnet-rpc.monad.xyz";
    const CHAIN_ID_DEC     = 10143;
    const CHAIN_ID_HEX     = "0x" + CHAIN_ID_DEC.toString(16);
    const TICKER           = "MONS";
    const DECIMALS         = 18;

    // ABIs (trimmed to what's needed)
    const MARKETPLACE_ABI = [
      {"inputs":[{"internalType":"string","name":"ticker","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"pricePerToken","type":"uint256"}],"name":"createListing","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"listingId","type":"uint256"}],"name":"cancelListing","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"listingId","type":"uint256"},{"internalType":"uint256","name":"amountToBuy","type":"uint256"}],"name":"purchaseInscriptions","outputs":[],"stateMutability":"payable","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"listingId","type":"uint256"},{"internalType":"uint256","name":"newPricePerToken","type":"uint256"}],"name":"updatePrice","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"ticker","type":"string"}],"name":"getActiveListingsForTicker","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"listingId","type":"uint256"}],"name":"getListing","outputs":[{"internalType":"address","name":"seller","type":"address"},{"internalType":"string","name":"ticker","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"pricePerToken","type":"uint256"},{"internalType":"bool","name":"active","type":"bool"},{"internalType":"uint256","name":"createdAt","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"getActiveListingsCount","outputs":[{"internalType":"uint256","name":"count","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"getTotalListingsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"nextListingId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"FEE_PERCENTAGE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"BASIS_POINTS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      // events
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"listingId","type":"uint256"},{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"ticker","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"totalPrice","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"fee","type":"uint256"}],"name":"InscriptionsPurchased","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"listingId","type":"uint256"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"string","name":"ticker","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"pricePerToken","type":"uint256"}],"name":"ListingCreated","type":"event"}
    ];

    const MON20_ABI = [
      {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getTokenInfo","outputs":[{"internalType":"uint256","name":"maxSupply","type":"uint256"},{"internalType":"uint256","name":"limitPerMint","type":"uint256"},{"internalType":"uint256","name":"minted","type":"uint256"},{"internalType":"address","name":"deployer","type":"address"},{"internalType":"uint256","name":"holdersCount","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getTotalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"}],"name":"getHoldersCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"tick","type":"string"}],"name":"getBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[],"name":"mintFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"tick","type":"string"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"payable","type":"function"}
    ];

    // State
    let provider, readProvider, signer, accounts = [];
    let marketplaceRead, marketplaceWrite, mon20Read, mon20Write;

    const fmtMon = v => {
      try { return ethers.formatEther(v); } catch { return "0" }
    }
    const toWei = v => ethers.parseEther(String(v || 0));
    const toUnit = v => ethers.parseUnits(String(v || 0), DECIMALS);
    const fmtMons = v => {
      try { return ethers.formatUnits(v, DECIMALS); } catch { return "0" }
    }
    const short = (addr) => addr ? addr.slice(0,6)+"…"+addr.slice(-4) : "—";
    const el = id => document.getElementById(id);

    async function ensureChain() {
      if (!window.ethereum) return false;
      const chainId = await window.ethereum.request({ method: 'eth_chainId' });
      if (chainId !== CHAIN_ID_HEX) {
        try {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: CHAIN_ID_HEX,
              chainName: 'Monad Testnet',
              nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
              rpcUrls: [RPC_URL],
              blockExplorerUrls: []
            }]
          });
        } catch (e) {
          console.warn('add chain error', e);
          return false;
        }
      }
      return true;
    }

    async function connect() {
      if (!window.ethereum) { alert('No wallet found. Please install MetaMask.'); return; }
      const ok = await ensureChain();
      if (!ok) return;
      accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      provider = new ethers.BrowserProvider(window.ethereum);
      signer = await provider.getSigner();
      readProvider = new ethers.JsonRpcProvider(RPC_URL, CHAIN_ID_DEC);

      marketplaceWrite = new ethers.Contract(MARKETPLACE_ADDR, MARKETPLACE_ABI, signer);
      marketplaceRead  = new ethers.Contract(MARKETPLACE_ADDR, MARKETPLACE_ABI, readProvider);
      mon20Write = new ethers.Contract(MON20_ADDR, MON20_ABI, signer);
      mon20Read  = new ethers.Contract(MON20_ADDR, MON20_ABI, readProvider);

      const net = await provider.getNetwork();
      el('netName').textContent = net.name || 'Monad Testnet';
      el('networkBadge').style.display = 'flex';
      const bal = await provider.getBalance(accounts[0]);
      el('monBalance').textContent = Number(fmtMon(bal)).toFixed(4);
      el('balanceBox').style.display = 'flex';
      el('connectBtn').textContent = short(accounts[0]);

      await refreshAll();
    }

    async function refreshAll(){
      await Promise.all([
        loadMonsStats(),
        loadListings(),
        loadVolumes()
      ]).catch(console.error);
      // also set user balance in sell modal
      try {
        if (accounts[0]) {
          const balMons = await mon20Read.getBalance(accounts[0], TICKER);
          el('userMonsBal').value = Number(fmtMons(balMons)).toLocaleString();
        }
      } catch {}
    }

    async function loadMonsStats(){
      try {
        const info = await mon20Read.getTokenInfo(TICKER);
        const maxSupply = info.maxSupply;
        const limitPerMint = info.limitPerMint;
        const minted = info.minted; // already 18d
        const holders = info.holdersCount;
        const pct = maxSupply > 0n ? (minted * 100n) / maxSupply : 0n;

        el('mintedStat').textContent = Number(fmtMons(minted)).toLocaleString();
        el('holdersStat').textContent = holders.toString();
        el('mintProgress').textContent = `${pct.toString()}% of ${Number(fmtMons(maxSupply)).toLocaleString()} MONS`;
        el('limitPerMint').textContent = Number(fmtMons(limitPerMint));

        // Mint fee
        const mfee = await mon20Read.mintFee();
        el('mintFeeDisplay').value = fmtMon(mfee);
      } catch (e) {
        console.error('loadMonsStats', e);
      }
    }

    function rowHtml({id, seller, amount, pricePerToken, createdAt}){
      const date = new Date(Number(createdAt) * 1000);
      const price = Number(fmtMon(pricePerToken));
      const amt = Number(fmtMons(amount));
      return `<tr class="border-t border-white/5">
        <td class="px-4 py-3 mono">#${id}</td>
        <td class="px-4 py-3 mono">${short(seller)}</td>
        <td class="px-4 py-3 mono">${amt.toLocaleString()}</td>
        <td class="px-4 py-3 mono">${price}</td>
        <td class="px-4 py-3 text-slate-300">${date.toLocaleString()}</td>
        <td class="px-4 py-3">
          <div class="flex gap-2">
            <input class="input mono w-28" type="number" min="1" step="1" id="buyAmt-${id}" placeholder="Amount"/>
            <button class="btn btn-primary" onclick="buy(${id})">Buy</button>
            <button class="btn" onclick="cancel(${id})">Cancel</button>
          </div>
        </td>
      </tr>`
    }

    async function loadListings(){
      try {
        const ids = await marketplaceRead.getActiveListingsForTicker(TICKER);
        el('activeListings').textContent = ids.length.toString();

        const details = await Promise.all(ids.map(async (id) => {
          const L = await marketplaceRead.getListing(id);
          return { id: Number(id), seller: L.seller, ticker: L.ticker, amount: L.amount, pricePerToken: L.pricePerToken, active: L.active, createdAt: L.createdAt };
        }));

        // floor price
        let floor = null;
        for (const d of details) {
          if (!floor || d.pricePerToken < floor) floor = d.pricePerToken;
        }
        el('floorPrice').textContent = floor ? Number(fmtMon(floor)) : '—';

        // render table
        el('listingsBody').innerHTML = details
          .sort((a,b)=> Number(a.pricePerToken) - Number(b.pricePerToken))
          .map(rowHtml).join('');
      } catch (e) { console.error('loadListings', e); }
    }

    async function loadVolumes(){
      try {
        // Build iface for event
        const iface = new ethers.Interface(MARKETPLACE_ABI);
        const topic = iface.getEvent("InscriptionsPurchased").topicHash;
        const latest = await readProvider.getBlockNumber();
        const span = 200_000; // look back blocks for performance
        const from = Math.max(0, latest - span);
        const logs = await readProvider.getLogs({ address: MARKETPLACE_ADDR, fromBlock: from, toBlock: latest, topics: [topic] });

        let total = 0n, day = 0n;
        const now = Math.floor(Date.now()/1000);
        for (const log of logs) {
          const ev = iface.decodeEventLog("InscriptionsPurchased", log.data, log.topics);
          // ev: listingId, buyer, seller, ticker, amount, totalPrice, fee
          if (ev.ticker !== TICKER) continue;
          total += ev.totalPrice;
          // get block timestamp
          const blk = await readProvider.getBlock(log.blockHash);
          if (blk && (now - Number(blk.timestamp)) <= 86400) day += ev.totalPrice;
        }
        el('volTotal').textContent = Number(fmtMon(total)).toFixed(4);
        el('vol24h').textContent = Number(fmtMon(day)).toFixed(4);
      } catch (e) { console.warn('volume scan limited', e); }
    }

    // Actions
    async function buy(id){
      try {
        if (!signer) await connect();
        const L = await marketplaceRead.getListing(id);
        const amtInput = document.getElementById(`buyAmt-${id}`);
        const amountToBuy = toUnit(amtInput.value || 0);
        if (amountToBuy <= 0n) { alert('Enter amount to buy'); return; }
        if (amountToBuy > L.amount) { alert('Amount exceeds listing'); return; }
        const totalValue = (L.pricePerToken * amountToBuy) / 10n**BigInt(DECIMALS);
        const tx = await marketplaceWrite.purchaseInscriptions(id, amountToBuy, { value: totalValue });
        el('mintMsg').textContent = 'Purchasing… tx sent: ' + tx.hash;
        await tx.wait();
        await refreshAll();
      } catch (e) { alert('Buy failed: ' + (e?.message || e)); }
    }

    async function cancel(id){
      try {
        if (!signer) await connect();
        const L = await marketplaceRead.getListing(id);
        if ((accounts[0]||'').toLowerCase() !== L.seller.toLowerCase()) { alert('Only seller can cancel'); return; }
        const tx = await marketplaceWrite.cancelListing(id);
        el('sellMsg').textContent = 'Cancel tx: '+tx.hash;
        await tx.wait();
        await refreshAll();
      } catch (e) { alert('Cancel failed: ' + (e?.message || e)); }
    }

    function toggleSell(open){
      el('sellModal').style.display = open ? 'grid' : 'none';
    }

    async function createListing(){
      try {
        if (!signer) await connect();
        const amount = toUnit(el('sellAmount').value || 0);
        const pricePer = toWei(el('sellPrice').value || 0);
        if (amount <= 0n) { alert('Enter amount'); return; }
        if (pricePer <= 0n) { alert('Enter price'); return; }
        const tx = await marketplaceWrite.createListing(TICKER, amount, pricePer);
        el('sellMsg').textContent = 'Listing tx: '+tx.hash;
        await tx.wait();
        toggleSell(false);
        await refreshAll();
      } catch (e) { alert('Create listing failed: ' + (e?.message || e)); }
    }

    async function quickMint(){
      try {
        if (!signer) await connect();
        const amtInt = parseInt(el('mintAmount').value || '0', 10);
        if (!amtInt || amtInt <= 0) { alert('Enter a mint amount'); return; }
        const info = await mon20Read.getTokenInfo(TICKER);
        const lim = Number(fmtMons(info.limitPerMint));
        if (amtInt > lim) { alert('Exceeds limit per mint'); return; }
        const fee = await mon20Read.mintFee();
        const tx = await mon20Write.mint(TICKER, toUnit(amtInt), { value: fee });
        el('mintMsg').textContent = 'Mint tx: '+tx.hash;
        await tx.wait();
        await refreshAll();
      } catch (e) { alert('Mint failed: ' + (e?.message || e)); }
    }

    // My listings filter
    async function showMyListings(){
      try {
        const ids = await marketplaceRead.getActiveListingsForTicker(TICKER);
        const details = await Promise.all(ids.map(async (id) => {
          const L = await marketplaceRead.getListing(id);
          return { id: Number(id), seller: L.seller, ticker: L.ticker, amount: L.amount, pricePerToken: L.pricePerToken, active: L.active, createdAt: L.createdAt };
        }));
        const mine = details.filter(d => (accounts[0]||'').toLowerCase() === d.seller.toLowerCase());
        el('listingsBody').innerHTML = mine.map(rowHtml).join('') || `<tr><td class='px-4 py-6 text-center text-slate-400' colspan='6'>No listings by you yet.</td></tr>`;
      } catch (e) { console.error(e); }
    }

    // Wire UI
    el('connectBtn').addEventListener('click', connect);
    el('refreshBtn').addEventListener('click', refreshAll);
    el('mintBtn').addEventListener('click', quickMint);
    el('sellOpenBtn').addEventListener('click', ()=> toggleSell(true));
    el('myListingsBtn').addEventListener('click', showMyListings);
    el('createListingBtn').addEventListener('click', createListing);

    // Close modal on background click
    el('sellModal').addEventListener('click', (e)=>{ if(e.target.id==='sellModal') toggleSell(false); });

    // Init read-only provider for non-connected users
    (async ()=>{
      readProvider = new ethers.JsonRpcProvider(RPC_URL, CHAIN_ID_DEC);
      marketplaceRead  = new ethers.Contract(MARKETPLACE_ADDR, MARKETPLACE_ABI, readProvider);
      mon20Read        = new ethers.Contract(MON20_ADDR, MON20_ABI, readProvider);
      await refreshAll();
    })();

    // React to wallet events
    if (window.ethereum){
      window.ethereum.on('accountsChanged', ()=> window.location.reload());
      window.ethereum.on('chainChanged', ()=> window.location.reload());
    }

    // Expose for inline buttons
    window.buy = buy;
    window.cancel = cancel;
    window.toggleSell = toggleSell;
  })();
  </script>
</body>
</html>
